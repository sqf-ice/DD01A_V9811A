C51 COMPILER V9.01   DRV_RTC                                                               03/11/2019 10:40:53 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DRV_RTC
OBJECT MODULE PLACED IN .\Drv_RTC.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\C_Source\S1_HardDrv\V9811A_MCU\Drv_RTC.c LARGE BROWSE INCDIR(..\C_Source
                    -\S0_System;..\C_Source\S1_HardDrv;..\C_Source\S2_MyLib;..\C_Source\S3_ApiPlat;..\C_Source\S4_ApiUser;..\C_Source\S5_ApiP
                    -rotocol;..\C_Source\S6_MyIncludes;..\C_Source\S1_HardDrv\V9811A_EMU;..\C_Source\S1_HardDrv\V9811A_MCU;..\C_Source\S1_Har
                    -dDrv\E2P_24CXXX) DEBUG OBJECTEXTEND PRINT(.\Drv_RTC.lst) OBJECT(.\Drv_RTC.obj)

line level    source

   1          /*
   2          *****************Copyright (c)*************************************
   3          **      Hangzhou Xili Watthour Meter Manufacture Co., Ltd. 
   4          **--------------file info--------------------------------------------
   5          **name                  : Drv_RTC.c
   6          **Author                : maji
   7          **date                  : 2016-04-20 
   8          **description   : RTCÄ£¿éµÄÓ²¼þÇý¶¯C´úÂë
   9          **note                  : V9811A £¬MERTER FOR DL03C
  10          **--------------------Version History -------------------------------------
  11          ** NO. Date         Ver      By         Description 
  12          **==============================================================
  13          ** 1   2016-04-26   v01.00   sosomj     1. frist version                             
  14          **
  15          **==============================================================
  16          */
  17          
  18          #include <MyIncludes_H.h>
  19          
  20          
  21          /*******************************************************************************************
  22          ** º¯ÊýÃû³Æ: Open_SecOut
  23          ** ¹¦ÄÜÃèÊö: ´ò¿ªÃëÊä³ö¹¦ÄÜ
  24          ** Èë¿Ú²ÎÊý: ÎÞ
  25          ** ³ö¿Ú²ÎÊý: ÎÞ
  26          ** ËµÃ÷    : 
  27          *******************************************************************************************/
  28          void Open_SecOut(void)
  29          {
  30   1          P13FS = 0x06; // PLLÃëÂö³åÊä³ö
  31   1                      
  32   1          P1OE&=~BIT3;        // output 
  33   1          P1IE&=~BIT3;        //
  34   1      }
  35          
  36          /*******************************************************************************************
  37          ** º¯ÊýÃû³Æ: Close_SecOut
  38          ** ¹¦ÄÜÃèÊö: ¹Ø±ÕÃëÊä³ö¹¦ÄÜ
  39          ** Èë¿Ú²ÎÊý: ÎÞ
  40          ** ³ö¿Ú²ÎÊý: ÎÞ
  41          ** ËµÃ÷    : 
  42          *******************************************************************************************/
  43          
  44          
  45          /*******************************************************************************************
  46          ** º¯ÊýÃû³Æ: Init_RTC
  47          ** ¹¦ÄÜÃèÊö: ³õÊ¼»¯RTC
  48          ** Èë¿Ú²ÎÊý: ÎÞ
  49          ** ³ö¿Ú²ÎÊý: ÎÞ
  50          ** ËµÃ÷    : 
  51          *******************************************************************************************/
  52          void Init_RTC(void)
C51 COMPILER V9.01   DRV_RTC                                                               03/11/2019 10:40:53 PAGE 2   

  53          {
  54   1              EIE|=BIT1;
  55   1              ExInt3IE|=BIT6;
  56   1      }
  57          
  58          /*******************************************************************************************
  59          ** º¯ÊýÃû³Æ: SetExtRTC
  60          ** ¹¦ÄÜÃèÊö: ÉèÖÃRTCÖÐ¶Ï»½ÐÑ¼ä¸ô
  61          ** Èë¿Ú²ÎÊý: uint8 SEC: intRTC=7µÄÊ±ºòÅäÖÃSECÃë»½ÐÑ
  62          **                        uint8 intRTC :intRTC ÅäÖÃËµÃ÷: 0, 1 Ãë£»1, 1 ·Ö£»2, 1 Ð¡Ê±£»3, 1 Ìì£»4, 500 ºÁÃë
             -£»
  63          **                                           5, 250 ºÁÃë£»6, 125 ºÁÃë£»7, ÅäºÏSECINTÉèÖÃÈÎÒâÃëÖÐ¶Ï
  64          ** ³ö¿Ú²ÎÊý: ÎÞ
  65          ** ËµÃ÷    : 
  66          *******************************************************************************************/
  67          void SetExtRTC(uint8 SEC,uint8 intRTC)
  68          {
  69   1          //RTCÔÊÐíÐ´ 
  70   1          RTCPEN = 0x96;      //password 1
  71   1          RTCPWD = 0x57;      //password 2
  72   1          Lib_Delay_2us(50);
  73   1              
  74   1          INTRTC = intRTC;
  75   1      /////////////////////////////////////////
  76   1      //ÉèÖÃÈÎÒâÃëÖÐ¶Ï  2016-2-18 mj//
  77   1          if(intRTC ==7)
  78   1          {
  79   2              SECINT = BIT6 ;
  80   2              SECINT += SEC&0x3f ;    
  81   2          }
  82   1      /////////////////////////////////////////
  83   1      
  84   1          Lib_Delay_2us(50);
  85   1          //RTC½ûÖ¹Ð´  
  86   1          RTCPEN = 0x96;
  87   1          RTCPWD = 0x56;
  88   1          Lib_Delay_2us(50);
  89   1      
  90   1      }
  91          
  92          /*******************************************************************************************
  93          ** º¯ÊýÃû³Æ: Get_RTCTime
  94          ** º¯ÊýÃèÊö: »ñÈ¡RTCÊ±¼ä
  95          ** ÊäÈë²ÎÊý: ÎÞ
  96          ** Êä³ö²ÎÊý: ÎÞ 
  97          ** ËµÃ÷    :  //  0-Ãë 1-·Ö 2-Ê± 3-ÖÜ 4-ÈÕ 5-ÔÂ 6-Äê //  
  98          *******************************************************************************************/
  99          void Get_RTCTime(RTC_TYPE *pTime)
 100          {
 101   1      volatile INT8U RTCFLAG ;
 102   1      
 103   1          RTCFLAG=RTCLATCH;     //ºÜÖØÒª£¬±¾²Ù×÷ÓÃÓÚËø¶¨RTCÊý¾Ý£¬±£Ö¤ÔÚ¶ÁÈ¡µÄ¹ý³ÌÖÐ²»±ä»¯  //
 104   1          Lib_Delay_2us(100);
 105   1              
 106   1          pTime->Week = RTCWC;             // weekday  // 
 107   1          pTime->Year = RTCYC;              // year  // 
 108   1          pTime->Month = RTCMoC;               // month  // 
 109   1          pTime->Day = RTCDC;               // day  // 
 110   1          pTime->Hour = RTCHC;              // hour  // 
 111   1          pTime->Minute = RTCMiC;              // minu  // 
 112   1          pTime->Second = RTCSC;              // sec  // 
 113   1      }
C51 COMPILER V9.01   DRV_RTC                                                               03/11/2019 10:40:53 PAGE 3   

 114                  
 115          /*******************************************************************************************
 116          ** º¯ÊýÃû³Æ: Get_RTCTime
 117          ** º¯ÊýÃèÊö: »ñÈ¡RTCÊ±¼ä
 118          ** ÊäÈë²ÎÊý: ÎÞ
 119          ** Êä³ö²ÎÊý: ÎÞ 
 120          ** ËµÃ÷    : //  0-Ãë 1-·Ö 2-Ê± 3-ÖÜ 4-ÈÕ 5-ÔÂ 6-Äê //  
 121          *******************************************************************************************/
 122          uint8 Set_RTCTime(RTC_TYPE *pTime)
 123          {
 124   1              //RTCÔÊÐíÐ´ 
 125   1          RTCPEN = 0x96;      //password 1
 126   1          RTCPWD = 0x57;      //password 2
 127   1          Lib_Delay_2us(50);
 128   1          //Ð´RTCÊ±¼ä
 129   1          RTCWC = pTime->Week;                //weekday
 130   1          RTCYC = pTime->Year;                //year
 131   1          RTCMoC = pTime->Month;      //month
 132   1          RTCDC = pTime->Day;         //day
 133   1          RTCHC = pTime->Hour;                //hour
 134   1          RTCMiC = pTime->Minute;     //minu
 135   1          RTCSC = pTime->Second;              //sec
 136   1          Lib_Delay_2us(50);
 137   1          //RTC½ûÖ¹Ð´  
 138   1      
 139   1          RTCPEN = 0x96;
 140   1          RTCPWD = 0x56;
 141   1         Lib_Delay_2us(50);
 142   1      
 143   1          return (TRUE);
 144   1      }
 145          
 146          
 147          
 148          /*******************************************************************************************
 149          ** º¯ÊýÃû³Æ: Clr_RTC_AdjParam
 150          ** º¯ÊýÃèÊö: Çå³ýRTCµÄÐ£Õý¼Ä´æÆ÷
 151          ** ÊäÈë²ÎÊý: ÎÞ
 152          ** Êä³ö²ÎÊý: ÎÞ 
 153          ** ËµÃ÷    :  ÎÞÎÂ²¹´¦ÀíµÄ±íÒªÇóÔÚÉÏµç³õÊ¼µÄÊ±ºòµ÷ÓÃ±¾º¯Êý
 154          *******************************************************************************************/
 155          void Clr_RTC_AdjParam(void)
 156          {
 157   1              //RTCÔÊÐíÐ´ 
 158   1          RTCPEN = 0x96;      //password 1
 159   1          RTCPWD = 0x57;      //password 2
 160   1          Lib_Delay_2us(50);
 161   1              RTCCH = 0x00;
 162   1              RTCCL = 0x00;
 163   1          //RTC½ûÖ¹Ð´  
 164   1      
 165   1          RTCPEN = 0x96;
 166   1          RTCPWD = 0x56;
 167   1              Lib_Delay_2us(50);
 168   1      
 169   1      }
 170          
 171          /*******************************************************************************************
 172          ** º¯ÊýÃû³Æ: SetRTCNormal
 173          ** º¯ÊýÃèÊö: Ð£ÕýRTCÆµÂÊ
 174          ** ÊäÈë²ÎÊý: int16 offset
 175          ** Êä³ö²ÎÊý: ÎÞ 
C51 COMPILER V9.01   DRV_RTC                                                               03/11/2019 10:40:53 PAGE 4   

 176          ** ËµÃ÷    : ÎÂ²¹º¯ÊýÖÐµ÷ÓÃ
 177          *******************************************************************************************/
 178          void SetRTCNormal(int16 offset)
 179          {
 180   1          ST_U32_U08 temp1,temp2;
 181   1          int16 temp3;
 182   1      
 183   1          temp2.u32=0;
 184   1          temp1.u32 =(uint16)offset;
 185   1          if((temp1.B08[2]>0x80))
 186   1          { 
 187   2              temp1.W16[1]=(~temp1.W16[1]);
 188   2              temp1.W16[1]&=0x1fff;
 189   2              temp1.u32=temp1.u32*20/30; 
 190   2              temp2.u32=(6553600/2) -1;
 191   2              temp2.u32=temp2.u32+(temp1.u32/2);
 192   2          }
 193   1          else
 194   1          {
 195   2              temp1.u32=(temp1.u32)*20/30;
 196   2              temp2.u32=(6553600/2);
 197   2              temp2.u32=temp2.u32-(temp1.u32/2);
 198   2          }
 199   1      
 200   1          temp3=offset/10;
 201   1          temp1.u32=(uint16)temp3;
 202   1          RTCPEN=0x96;              //          // 1S»½ÐÑ//
 203   1          RTCPWD=0x57;
 204   1          Lib_Delay_2us(50);
 205   1          RTCCH=temp1.B08[2];
 206   1          RTCCL=temp1.B08[3];
 207   1          DIVTHH=temp2.B08[1];
 208   1          DIVTHM=temp2.B08[2];
 209   1          DIVTHL=temp2.B08[3];
 210   1      
 211   1          Lib_Delay_2us(50);
 212   1          RTCPEN=0x96;
 213   1          RTCPWD=0x56;
 214   1      }
 215          
 216          
 217          /*******************************************************************************************
 218          ** º¯ÊýÃû³Æ: Handl_RTC_Adj_per_minu
 219          ** º¯ÊýÃèÊö: RTCÎÂ²¹¿ØÖÆ³ÌÐò
 220          ** ÊäÈë²ÎÊý: ÎÞ
 221          ** Êä³ö²ÎÊý: ÎÞ 
 222          ** ËµÃ÷    :  ÎÞÎÂ²¹´¦ÀíµÄ±íÒªÇóÔÚÉÏµç³õÊ¼µÄÊ±ºòµ÷ÓÃ±¾º¯Êý
 223          *******************************************************************************************/
 224          void Handl_RTC_Adj_per_minu(void)
 225          {
 226   1       uint8 i;  
 227   1       uint8 code *p;
 228   1       ST_U32_U08 temp1;
 229   1       float temperature; //µ±Ç°ÎÂ¶È//
 230   1      
 231   1       int16 delta;
 232   1       int16  OSC;
 233   1       int32 Bpara;
 234   1       uint8 Ti;
 235   1      
 236   1      
 237   1          return;
C51 COMPILER V9.01   DRV_RTC                                                               03/11/2019 10:40:53 PAGE 5   

 238   1      
 239   1          Bpara = 0x061A80;
 240   1          Ti= 24;
 241   1          p=(uint8 code*)0x48C;               // RTC³£ÎÂÆ«ÒÆ//
 242   1      
 243   1          for(i=0;i<3;i++)
 244   1          {
 245   2              Lib_FCpyTMem((uint8*)&temp1.B08[0],p+(i*4),4);  
 246   2              temp1.B08[2] = Lib_get_csck_int8u_num((uint8*)&temp1.B08[0],2,0x33);
 247   2              if(temp1.B08[2] == temp1.B08[3])
 248   2              {
 249   3                  break;
 250   3              }
 251   2          }
 252   1      
 253   1          if(temp1.B08[2] != temp1.B08[3])
 254   1          {
 255   2              temp1.W16[0]= 0;                // Ð£Ñé³ö´í Ä¬ÈÏ
 256   2          }
 257   1          delta=temp1.W16[0];
 258   1      
 259   1          //»ñÈ¡ÎÂ¶È  //
 260   1          Enable_M_ADC(M_ADC_CH1_TEMPERATURE);
 261   1          Lib_Delay_ms(10);
 262   1          temperature = Cal_temperature_data();
 263   1          //¼ÆËãÊý¾Ý  //
 264   1          OSC=(int16)((((float)Bpara)*(temperature-((float)Ti))*(temperature-((float)Ti)))/1000000+delta);            // ¾
             -«¹¤Ìá¹©//
 265   1          //Ð£×¼Êý¾Ý  //
 266   1          SetRTCNormal(OSC);
 267   1      
 268   1      }
 269          
 270          
 271          
 272          /*******************************************************************************************
 273          **    END
 274          *******************************************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    698    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      37
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
